# vim: set ft=ruby ts=4 sw=4 sts=-1 noet:

include_module_dir "modules.d";

module base {
	# Begin with the kernel defconfig
	merge "{KERNEL_DIR}/arch/x86/configs/x86_64_defconfig";

	# Enable expert options
	set EXPERT y;
	# Enable modules
	set MODULES y;
}

module bluetooth_extra {
	# Enable BT high speed
	set BT_HS y;
	# Enable BT low energy
	set BT_LE y;
	# Enable BT led triggers
	set BT_LEDS y;

	# HID over bluetooth
	#set BT_HIDP y;
	# Ethernet over bluetooth
	#set BT_BNEP y;
	# Rfcomm (Dialup, Obex)
	#set BT_RFCOMM y;
}

module kvm {
	set KVM y;
}

module net {
	# Enable netfilter and allow ip forwarding
	set NETFILTER_ADVANCED y;
	set IP_NF_TARGET_REDIRECT y;

	# IPv6 through IPv4 tunnel as module
	set IPV6_SIT y;

	# Enable universal TUN/TAP (e.g. for openvpn)
	set TUN y;

	#set WIREGUARD y;

	# Enable kernel tls support
	set TLS y;
}

module usb {
	set USB y;
	# Enable usb led triggers
	set USB_LED_TRIG y;
	# usb xHCI (USB 3.0) support
	set USB_XHCI_HCD y;

	# usb type c support
	set TYPEC y;
	set TYPEC_TCPM y;
	set TYPEC_TCPCI y;
	set TYPEC_UCSI y;
	set UCSI_ACPI y;
}

module usb_extra {
	# Enable usb mass storage devices
	set USB_STORAGE y;
	# enable usb audio
	set SND_USB_AUDIO y;

	# Enable DisplayPort via usb typec
	set TYPEC_DP_ALTMODE y;
};

module thunderbolt {
	# Enable thunderbolt support
	set THUNDERBOLT y;
}

module thunderbolt_extra {
	# Enable networking over thunderbolt
	set THUNDERBOLT_NET y;
}

module local_extra {
	# Intel thunderbold driver
	set INTEL_WMI_THUNDERBOLT y;
	# Touchpad
	set MOUSE_PS2_ELANTECH y;
	# Enable battery reporting for HID devices
	set HID_BATTERY_STRENGTH y;

	# Enable intel sensor hub to offload sensor polling to coprocessor (Skylake+)
	set INTEL_ISH_HID y;

	# Enable powercapping
	set POWERCAP y;
	set INTEL_RAPL y;

	# Enable performance events
	set PERF_EVENTS y;
	set PERF_EVENTS_INTEL_UNCORE y;
	set PERF_EVENTS_INTEL_RAPL y;
	set PERF_EVENTS_INTEL_CSTATE y;

	# Enable crypto intrinsics
	set CRYPTO_CRC32C_INTEL y;

	# Enable hardware random
	set HW_RANDOM y;
	set HW_RANDOM_INTEL y;

	# DMA support for Intel low power subsystem (Skylake+)
	set INTEL_IDMA64 y;
	# Enable kvm support for intel
	set KVM_INTEL y;
}

module plug_extra {
	# Enable usb serial converters (for arduino)
	set USB_SERIAL y;
	set USB_SERIAL_CP210X y;

	# rtlsdr support
	set MEDIA_SUPPORT y;
	set MEDIA_USB_SUPPORT y;
	set MEDIA_DIGITAL_TV_SUPPORT y;
	set DVB_USB_V2 y;
	set DVB_USB_RTL28XXU y;
}

module misc {
	# Use lz4 as compression
	set CRYPTO_LZ4 y;
	set KERNEL_LZ4 y;

	# Enable .config access through /proc/config.gz
	set IKCONFIG y;
	set IKCONFIG_PROC y;

	# Increase console scrollback and enable persistence on vgacon consoles
	set VGACON_SOFT_SCROLLBACK y;
	set VGACON_SOFT_SCROLLBACK_SIZE 1024;
	set VGACON_SOFT_SCROLLBACK_PERSISTENT_ENABLE_BY_DEFAULT y;

	# Don't precreate loop devices
	set BLK_DEV_LOOP_MIN_COUNT 0;

	# Allow more than 8 audio devices
	set SND_DYNAMIC_MINORS y;
	# Increase prealloc size for HD Audio driver
	set SND_HDA_PREALLOC_SIZE 2048;

	# Enable kernel samepage merging (useful for duplicative programs like KVM)
	set KSM y;
	# Enable cpu frequency statistics
	set CPU_FREQ_STAT y;

	# Enable setting system time from RTC on startup and resume
	set RTC_HCTOSYS y;

	# Enable lockup detector
	set SOFTLOCKUP_DETECTOR y;
	set HARDLOCKUP_DETECTOR y;

	# Enable scheduler autogroup to automatically create task groups for
	# CPU aggressive applications and separate them from desktop applications
	set SCHED_AUTOGROUP y;
}

kernel {
	use base;
	use security;
	use local;

	use nvme;
	use fs_ntfs;
	use fs_f2fs;
	use fs_fuse;
	use fs_cifs;

	use kvm;
	use net;

	use usb;
	use usb_extra;
	use thunderbolt;
	use thunderbolt_extra;
	use bluetooth_extra;

	use local_extra;
	use plug_extra;
	use misc;

	# Enable efi
	set EFI y;
	set EFI_STUB y;

	# No boot logo
	set LOGO n;
	set DEFAULT_HOSTNAME "(none)";
}

initramfs {
	genkernel {
		add_params "--luks";
	}

	#TODO compress lz4;

	add_cmdline "root=/dev/by-partuuid/{}";
}

build {
	#pre_check "blah.sh" # check eselect that there is no new version.
	#umask 0022;
	#post_build 'emerge @module-rebuild'

	initramfs true;
	pack cmdline;
	pack initramfs;
}

install {
	efi {
		#add_entry "gentoo";
		#add_entry "gentoo-fallback" "additional.cmdline=something" "even.more=1 yet.another=true";
		#sign true;
		#signkey ...
	}

	#mount /boot/efi;
	#assert_mounted "/boot/efi";

	target_dir "/boot/efi/EFI";

	#install_system_map false;
	#install_bzimage true;
	#install_modules auto;

	#keep_old 1;
	#exec_pre  "/.../pre_install.sh";
	#exec_post "/.../post_install.sh";
}
